{% extends "base.html" %}

{% block title %}Cart | Maison √âcorce{% endblock %}

{% block content %}
<section class="cart-page">
    <div class="container">
        <div class="cart-header">
            <h1>Your Cart</h1>
        </div>

        <div class="cart-layout" id="cartLayout">
            <div class="cart-items" id="cartItems">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <aside class="cart-summary" id="cartSummary">
                <h3 class="cart-summary-title">Order Summary</h3>
                <div class="cart-summary-row">
                    <span>Subtotal</span>
                    <span id="subtotal">GHS0</span>
                </div>
                <div class="cart-summary-row">
                    <span>Shipping</span>
                    <span id="shipping">Calculated at checkout</span>
                </div>
                <div class="cart-summary-row total">
                    <span>Total</span>
                    <span class="value" id="cartTotalDisplay">GHS0</span>
                </div>
                <a href="/checkout" class="btn btn-primary btn-lg cart-summary-btn" id="checkoutBtn">
                    Proceed to Checkout
                </a>
                <a href="/shop" class="btn btn-ghost w-full text-center" style="margin-top: var(--space-sm);">
                    Continue Shopping
                </a>
            </aside>
        </div>

        <div class="cart-empty" id="cartEmpty" style="display: none;">
            <div class="cart-empty-icon">üõçÔ∏è</div>
            <h3 style="margin-bottom: var(--space-sm);">Your cart is empty</h3>
            <p class="text-muted" style="margin-bottom: var(--space-md);">
                Looks like you haven't added any fragrances yet.
            </p>
            <a href="/shop" class="btn btn-primary">Explore Collection</a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadCart();
    });

    async function loadCart() {
        const itemsContainer = document.getElementById('cartItems');
        const summaryContainer = document.getElementById('cartSummary');
        const emptyContainer = document.getElementById('cartEmpty');
        const cartLayout = document.getElementById('cartLayout');

        try {
            const response = await fetch('/api/cart');
            const cart = await response.json();

            if (cart.length === 0) {
                cartLayout.style.display = 'none';
                emptyContainer.style.display = 'block';
                return;
            }

            cartLayout.style.display = 'grid';
            emptyContainer.style.display = 'none';

            itemsContainer.innerHTML = cart.map(item => `
            <div class="cart-item" data-id="${item.id}">
                <div class="cart-item-image">
                    <img src="${item.image}" alt="${item.name}">
                </div>
                <div class="cart-item-info">
                    <h4 class="cart-item-name">${item.name}</h4>
                    <p class="cart-item-price">GHS${item.price.toLocaleString()}</p>
                    <div class="quantity-selector" style="margin-top: var(--space-sm);">
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">‚àí</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="10" 
                               onchange="updateQuantity(${item.id}, parseInt(this.value))">
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                </div>
                <div class="cart-item-actions">
                    <span class="cart-item-total">GHS${(item.price * item.quantity).toLocaleString()}</span>
                    <button class="cart-item-remove" onclick="removeItem(${item.id})">Remove</button>
                </div>
            </div>
        `).join('');

            updateSummary(cart);

        } catch (error) {
            itemsContainer.innerHTML = `<p class="text-muted">Unable to load cart. Please refresh.</p>`;
        }
    }

    function updateSummary(cart) {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal > 50000 ? 0 : 3000;
        const total = subtotal + shipping;

        document.getElementById('subtotal').textContent = `GHS${subtotal.toLocaleString()}`;
        document.getElementById('shipping').textContent = shipping === 0 ? 'Free' : `GHS${shipping.toLocaleString()}`;
        document.getElementById('cartTotalDisplay').textContent = `GHS${total.toLocaleString()}`;

        document.getElementById('checkoutBtn').style.pointerEvents = cart.length === 0 ? 'none' : 'auto';
        document.getElementById('checkoutBtn').style.opacity = cart.length === 0 ? '0.5' : '1';
    }

    async function updateQuantity(id, quantity) {
        if (quantity < 1) {
            removeItem(id);
            return;
        }

        try {
            await fetch('/api/cart/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, quantity })
            });
            loadCart();
            refreshCartCount();
        } catch (error) {
            showToast('Failed to update quantity', 'error');
        }
    }

    async function removeItem(id) {
        try {
            await fetch('/api/cart/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            loadCart();
            refreshCartCount();
            showToast('Item removed from cart', 'success');
        } catch (error) {
            showToast('Failed to remove item', 'error');
        }
    }

    async function refreshCartCount() {
        const response = await fetch('/api/cart');
        const cart = await response.json();
        updateCartCount(cart.reduce((sum, item) => sum + item.quantity, 0));
    }
</script>
{% endblock %}